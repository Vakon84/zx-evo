;BMP Viewer & Sprite Cutter;(C) BUDDER/MGN/2012;---------------------------------------        ORG #6000;-------QUAC    EQU 255SPAGE   EQU 16;-------WLD     EQU #6006TMN     EQU #6009;Timer;-------Vfm     EQU #15AF;---------------------------------------;HEADER:        DS 16        DB "WildCommanderMDL";    Header        DB #02;                  Version        DB 0;                       Type        DB 1; Pages        DB 0; Page to #8000;-------        DB 0,8; CODE.5      DB 0,0;-------        DS 16;-------        DB "BMP"        DS 31*3;-------        DB 0;-------        DW #0000,#0002; MAX SIZE;-------        DB "BMP Viewer v0.4b"        DB "                ";-------        DB 0;---------------------------------------        ORG #8000,#6200;-------LOBU    EQU #B000LOBE    EQU LOBU+#0800PALREZ  EQU LOBE;---------------------------------------PLUGIN  LD (DAHL),HL,(DADE),DE        CALL GEDPL        XOR A        LD (SPF),A        LD (LFL),A        LD (ESTAT),A        LD H,A,L,A        LD (XXX),HL        LD (YYY),HL        LD A,SPAGE        LD (PGA),A        LD (PGB),A        LD HL,#C000        LD (SRAD),HL        LD A,254,(IDX),A:CALL SETU        CALL KOPT        CALL GENPAL;-------MAIN    EI:HALT:CALL LINER        CALL TABK,NZ,SETUP        CALL F5,NZ,DECX        CALL UPPP,NZ,UPN        CALL DWWW,NZ,DWN        CALL LFFF,NZ,LFN        CALL RGGG,NZ,RGN        CALL ENKE,NZ,GETSPR        CALL F10:JR NZ,EXIT        CALL ESC:JR Z,MAINEXIT    CALL GEDPL;LD IX,PLWND:CALL PRWOW;LD HL,CCNT+1,BC,255:XOR A:CPIR;LD DE,CCNT:OR A:SBC HL,DE;EX DE,HL;LD A,D,HL,TXT+1:CALL NORK;LD A,E,HL,TXT+3:CALL NORK;_LD HL,TXT,DE,#0101,BC,5:CALL PRSRW;CALL USPO;CALL NUSP;LD IX,PLWND:CALL RRESB        CALL SAVEK        LD A,(ESTAT)        RET;-------NXFL    LD A,2,(ESTAT),A:JR EXIT;-------UPN     LD HL,(YYY),DE,8;(HEI)        OR A:SBC HL,DEELE     LD A,H:CP #02:RET NC        PUSH HL:CALL RLINE        POP HL        LD (YYY),HL        JP LINERDWN     LD HL,(YYY),DE,8;(HEI)        ADD HL,DE        JR ELE;-------LFN     LD HL,(XXX),DE,8;(WID)        OR A:SBC HL,DE        LD A,H:CP #02:RET NCRM      PUSH HL:CALL RLINE        POP HL        LD (XXX),HL        JP LINERRGN     LD DE,8Rgn     LD HL,(XXX)        ADD HL,DE        LD A,H:CP #02:JR C,RM        CALL DWN        CALL RLINE        LD HL,0,(XXX),HL        JP LINER;-------RGN2    LD DE,(WID):JR Rgn;-------DECX    CALL RLINE        LD HL,RTPRESE,DE,WID,BC,8:LDIR        JP LINER;---------------------------------------SAVEK   CALL PAS:RET Z        PUSH HL:CALL INAME        POP HL:RET NZ        LD A,3,(ESTAT),A        CALL GOSAVE        CALL RRESB        RETGOSAVE  LD A,(SPF):OR A:JR NZ,NOPAL        LD DE,32:ADD HL,DENOPAL   LD (FLSIZE),HL,HL,0        LD (FLSIZE+2),HL        LD DE,FLNAME        LD HL,FLSIZE:CALL MKFILE:RET NZ        LD A,(SPF):OR A:JR NZ,GA3GA2     LD A,(PGA):CALL MNGCVPL        LD HL,#C000-32:CALL GAD:RET Z        LD DE,#C000-32,BC,32:LDIR        LD HL,PGA:INC (HL)        LD A,(PGB):CP (HL):JR NC,GA2        RET;-------GA3     LD A,(PGA):CALL MNGCVPL        LD HL,#C000:CALL GAD:RET Z        LD HL,PGA:INC (HL)        LD A,(PGB):CP (HL):JR NC,GA3;-------GAD     LD B,1:CALL SAVE512:CP #0F:RET Z        LD A,H:CP #FF:JR C,GAD        LD A,1:OR A        RET;---------------------------------------PAS     LD BC,CCNT        LD DE,#C000-32        LD A,16VEK     EXA        LD A,(BC):INC BC        LD H,0,L,A:ADD HL,HL        LD A,H:ADD A,PALREZ[:LD H,A        LD A,(HL),(DE),A:INC DE,HL        LD A,(HL),(DE),A:INC DE        EXA:DEC A:JR NZ,VEK        LD HL,(SRAD),DE,#C000        OR A:SBC HL,DE        LD A,(PGB):SUB SPAGE        AND %00000011.2      RRCA        ADD A,H:LD H,A:OR L:RET Z        LD A,1:OR A        RET;---------------------------------------ALPHA   LD HL,PALREZ        LD BC,#1800C4E     LD A,B        CP (HL):INC HL:JR NZ,TOO        LD A,#60:CP (HL):RET ZTOO     INC HL,C:RET Z        JP C4E;---------------------------------------GENPAL  CALL ALPHA        LD HL,CCNT,DE,HL:INC DE        LD (HL),C,BC,255:LDIR        LD IX,CCNT+1        XOR A:LD (PAGN),A        EXX:LD HL,0        EXXNYA     LD DE,#C000        EXX:PUSH HL:EXX        CALL MNGCVPL        EXX:POP HL:EXXNXT     LD A,(DE),HL,CCNT,BC,256        CPIR:JR Z,AXT        LD (IX),A:INC IXAXT     INC DE:BIT 0,D:JR Z,NXT        LD A,E:AND %11000000:JR Z,NXT        EXX:INC L:LD A,L:CP 240:RET NC        EXX        INC D:LD E,0:JR NZ,NXT        LD A,(PAGN):INC A:LD (PAGN),A        JR NYA;---------------------------------------GETSPR  CALL RLINE        LD HL,(XXX),DE,(YYY),IX,TTBU        LD BC,(HEI)TP      LD A,(WID),B,ATSP     PUSH HL,DE        CALL POINTR:LD (IX),A:INC IX        POP DE,HL:INC HL        DJNZ TSP        OR A        PUSH DE:LD DE,(WID):SBC HL,DE        POP DE:INC DE        DEC C:JR NZ,TP;-------        LD A,(PGB):CALL MNGCVPL        LD DE,(SRAD)        PUSH DE:LD HL,TTBU,BC,(COu):LDIR        POP HL        PUSH HL:CALL CNV16C        POP HL        CALL CNV16F        LD A,B:OR A:JR NZ,JZ        LD HL,PGB:INC (HL)        LD BC,#C000JZ      LD (SRAD),BC;-------        CALL LINER        JP RGN2;---------------------------------------CNV16C  LD BC,(COu)BAB     LD A,(HL)        EXX        LD HL,CCNT        LD BC,16:CPIR:JR NZ,HAB        LD A,15:SUB C        AND %00001111HAB     EXX        LD (HL),A:INC HL        DEC BC:LD A,B:OR C:JR NZ,BAB        RET;-------CNV16F  LD DE,HL,BC,HL        EXX:LD BC,(COU)DAX     EXX.4      SLA (HL)        INC DE:LD A,(DE):OR (HL)        INC HL,HL,DE        LD (BC),A:INC BC        EXX:DEC BC:LD A,B:OR C:JR NZ,DAX        EXX        RET;---------------------------------------LINER   LD A,(LFL):OR A:CALL Z,LNN:RET;-------LNN     LD A,1,(LFL),A        LD IX,LNBU        LD HL,(XXX),DE,(YYY)        LD A,(WID),B,ALDK1    PUSH HL,DE,BC        LD A,QUAC:CALL POINTP        POP BC,DE,HL        LD (IX),A:INC HL,IX        DJNZ LDK1        DEC HL        LD A,(HEI),B,A:DEC BLDK2    INC DE        PUSH HL,DE,BC        LD A,QUAC:CALL POINTP        POP BC,DE,HL        LD (IX),A:INC IX        DJNZ LDK2        LD A,(WID),B,A:DEC BLDK3    DEC HL        PUSH HL,DE,BC        LD A,QUAC:CALL POINTP        POP BC,DE,HL        LD (IX),A:INC IX        DJNZ LDK3        LD A,(HEI),B,A:DEC B,BLDK4    DEC DE        PUSH HL,DE,BC        LD A,QUAC:CALL POINTP        POP BC,DE,HL        LD (IX),A:INC IX        DJNZ LDK4        RET;---------------------------------------RLINE   CALL LN2:RET;-------LN2     XOR A:LD (LFL),A        LD IX,LNBU        LD HL,(XXX),DE,(YYY)        LD A,(WID),B,ALDR1    PUSH HL,DE,BC        LD A,(IX):CALL POINTP        POP BC,DE,HL        INC HL,IX        DJNZ LDR1        DEC HL        LD A,(HEI),B,A:DEC BLDR2    INC DE        PUSH HL,DE,BC        LD A,(IX):CALL POINTP        POP BC,DE,HL:INC IX        DJNZ LDR2        LD A,(WID),B,A:DEC BLDR3    DEC HL        PUSH HL,DE,BC        LD A,(IX):CALL POINTP        POP BC,DE,HL:INC IX        DJNZ LDR3        LD A,(HEI),B,A:DEC B,BLDR4    DEC DE        PUSH HL,DE,BC        LD A,(IX):CALL POINTP        POP BC,DE,HL:INC IX        DJNZ LDR4        RET;---------------------------------------POINTP  ;i:HL - X (0-511);          DE - Y (0-511);           A - Value to Screen;        o: A - Value from Screen        PUSH AF,DE.5      SRL D:RR E        LD A,E:AND %00001111        CALL MNGCVPL        POP DE        LD A,E:AND %00011111:ADD A,A        LD DE,#C000:ADD A,D:LD D,A        ADD HL,DE        POP AF        LD C,(HL),(HL),A,A,C        RETPOINTR  ;i:HL - X;          DE - Y;        o:HL - Address in Screen        PUSH DE.5      SRL D:RR E        LD A,E:AND %00001111        CALL MNGCVPL        POP DE        LD A,E:AND %00011111:ADD A,A        LD DE,#C000:ADD A,D:LD D,A        ADD HL,DE        LD A,(HL)        RET;---------------------------------------KOPT    LD HL,LOBU,B,4:CALL LOAD512        LD HL,LOBU+#36        LD DE,512:CALL PALCNV        LD HL,512,DE,PALREZ,BC,HL:LDIR;-------        LD A,%10000010:CALL GVmod        LD A,1:CALL MNGV_PL        EI:HALT        LD HL,%0101001010010100        LD (512+510),HL        CALL PABE        LD HL,512,DE,0,BC,HL:LDIR        CALL PAED;-------        XOR A        LD (EOF),A        LD A,7,(PAGN),A        LD HL,LOBU+#36+1024        LD DE,#E000-512ELEK    LD A,(PAGN):CALL MNGCVPLVSEGDA  LD BC,320PEKA    LDI        LD A,H:CP LOBE[:CALL NC,OVER        LD A,B:OR C:JP NZ,PEKA        LD E,0:DEC D,D,D        LD A,D:CP #C0:JR NC,VSEGDA        LD A,(EOF):OR A:RET NZ        LD A,(PAGN):DEC A:CP #FF:RET Z        LD (PAGN),A        LD DE,#0000-512        JR ELEK;-------OVER    PUSH DE,BC        LD HL,LOBU,B,4:CALL LOAD512        LD (EOF),A        LD HL,LOBU        POP BC,DE        RET;---------------------------------------PAED    LD BC,Vfm:XOR A:OUT A:RETPABE    LD A,%00010000,BC,Vfm:OUT A:RET;-------PALCNV  ;i:HL - BGRN(4) 1024b Buffer;        o:DE - RGB(2) 512b Buffer        EXX:LD E,0        EXX        LD B,0CNV     PUSH BC        LD A,(HL):INC HL:CALL DEL10        LD A,C:AND %00011000        EXX:LD L,A,H,E        EXX        LD A,(HL):INC HL:CALL DEL10        LD A,C:AND %00011000        EXX:LD B,E,C,A.5      SLA C:RL B        ADD HL,BC        EXX        LD A,(HL):INC HL:CALL DEL10        LD A,C:AND %00011000        EXX.2      SLA A        OR H:EXA:LD A,L        EXX        INC HL        LD (DE),A:INC DE:EXA        LD (DE),A:INC DE        POP BC        DJNZ CNV        RETDEL10   LD BC,#0AFFDEL     INC C        SUB B:RET C        JP DEL;---------------------------------------SETUP   CALL RLINE        CALL SETU        JP LINER;-------SETU    LD A,(IDX):INC A        CP 7:JR C,$+3:XOR A        LD (IDX),A        LD H,0,L,A.3      ADD HL,HL        LD DE,PRESETS:ADD HL,DE        LD DE,WID,BC,8:LDIR        RET;---------------------------------------INAME   LD IX,PLWND:CALL PRWOW_LD HL,TXT00,DE,#000B,BC,13:CALL PRSRW_LD A,%11110111:CALL PRIAT_LD HL,TXT04,DE,#0205,BC,26:CALL PRSRW_LD A,%01111110:CALL PRIAT_LD HL,TXT01,DE,#0101,BC,5:CALL PRSRW_LD A,%01110001:CALL PRIAT        LD HL,TXT03,DE,#0106,BC,12        PUSH DE        CALL PRSRW        LD A,%01110000:CALL PRIAT        POP DE        CALL GADRW        PUSH HL        LD DE,#0800,A,#FF:CALL ISTRTIK     EI:HALT:CALL SPX        CALL UPPP,NZ,SPD        CALL DWWW,NZ,SPE        CALL ENKE:JR NZ,TEX        CALL ESC:JR NZ,TEX2        LD A,#00:CALL ISTR        JR TIKTEX     LD A,#01:CALL ISTR        POP HL        LD DE,FLNAME,BC,8:LDIR_LD HL,TXTZZ,DE,#0101,BC,32:CALL PRSRW_LD HL,TXTZZ,DE,#0201,BC,32:CALL PRSRW_LD HL,TXT02,DE,#0101,BC,21:CALL PRSRW_LD A,%01111110:CALL PRIAT        XOR A        RET;-------TEX2    POP HL        CALL RRESB        LD A,1:OR A        RET;-------SPD     LD A,1,(SPF),A :RETSPE     XOR A:LD (SPF),A:RETSPX     LD A,(SPF):OR A        LD HL,TXT05:JR Z,$+5:LD HL,TXT06        LD DE,#0114,BC,12:CALL PRSRW        LD A,%01111111:JP PRIAT;---------------------------------------PRWOW   LD A,1:JP WLDRRESB   LD A,2:JP WLDPRSRW   LD A,3:JP WLDPRIAT   EXA:LD A,4:JP WLDGADRW   LD A,5:JP WLDISTR    EXA:LD A,9:JP WLDNORK    EXA:LD A,10:JP WLDGEDPL   LD A,15:JP WLD;-------UPPP    LD A,17:JP WLDDWWW    LD A,18:JP WLDLFFF    LD A,19:JP WLDRGGG    LD A,20:JP WLDTABK    LD A,21:JP WLDENKE    LD A,22:JP WLDESC     LD A,23:JP WLDF1      LD A,29:JP WLDF5      LD A,33:JP WLDF10     LD A,38:JP WLDUSPO    LD A,46:JP WLDNUSP    LD A,47:JP WLD;-------LOAD512 LD A,48:JP WLDLOAD256 LD A,60:JP WLDLOADNON LD A,61:JP WLDSAVE512 LD A,49:JP WLDMKFILE  LD A,58:JP WLD;-------MNGV_PL EXA:LD A,64:JP WLDMNGCVPL EXA:LD A,65:JP WLDGVmod   EXA:LD A,66:JP WLD;---------------------------------------PLWND   DB 0,0        DB 23,13;    X,Y        DB 32+2,2+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES;-------ERWND   DB 0,0        DB 23,13;    X,Y        DB 32+2,1+2; W,H        DB %00101111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES;-------PRESETS DW 16,16,128,256        DW 8,16,64,128        DW 16,8,64,128        DW 8,8,32,64        DW 32,32,512,1024        DW 16,32,256,512        DW 32,16,256,512;-------RTPRESE DW 80,72,2880,5760;-------FLNAME  DB "SPRITES SPR",0FLSIZE  DS 4;---------------------------------------TXT     DB "#    "TXT00   DB "Save Sprites:"TXT01   DB "Name:"TXT02   DB "            Saving..."TXT03   DB "SPRITES .SPR"TXT04   DB "ENTER - Save; ESC - EXIT! "TXT05   DB "+ Pallete ",#18,#19TXT06   DB "- Pallete ",#19,#18TXTZZ   DS 32,32;---------------------------------------SPBU    DS 2DAHL    DS 2DADE    DS 2XXX     DS 2YYY     DS 2SPF     NOPLFL     NOPEOF     NOPPAGN    NOPESTAT   NOPPGA     NOPPGB     NOPSRAD    DS 2IDX     NOPWID     DS 2HEI     DS 2COU     DS 2COu     DS 2;-------LNBU    DS 90*4;  Lines BufferC16P    DS 2*16;  PallitCCNT    DS 256TTBU    ;         Sprite Buffer;---------------------------------------