P_CONF  EQU #77P_DATA  EQU #57CMD_12  EQU #4CCMD_18  EQU #52CMD_25  EQU #59CMD_55  EQU #77CMD_58  EQU #7ACMD_59  EQU #7BACMD_41 EQU #69;---------------------------------------RDDSEsd ;i:HL(4) - Sector number;             DE - Address        PUSH DE        LD E,(HL):INC HL        LD D,(HL):INC HL        LD C,(HL):INC HL        LD B,(HL)        POP HL:LD A,B:CP #FF:RET Z        LD A,CMD_18:CALL SECM200RDSD1   CALL IN_OUT:CP #FE:JR NZ,$-5        CALL READSsd        LD A,CMD_12:CALL OUT_COM        CALL IN_OUT:INC A:JR NZ,$-4        JP CS_HIGH;---------------------------------------SDDSEsd ;i:HL(4) - Sector number;             DE - Address        PUSH DE        LD E,(HL):INC HL        LD D,(HL):INC HL        LD C,(HL):INC HL        LD B,(HL)        POP HL:LD A,B:CP #FF:RET Z        XOR A:IN A,(P_CONF)        AND 2:JR NZ,XORK        LD A,B:OR C,D,E        LD A,3:RET Z        LD A,CMD_25:CALL SECM200        CALL IN_OUT:INC A:JR NZ,$-4SD1     LD A,#FC:CALL SAVDSsd        CALL IN_OUT:INC A:JR NZ,$-4        LD C,P_DATA,A,#FD:OUT A        CALL IN_OUT:INC A:JR NZ,$-4        JP CS_HIGH;-------XORK    XOR A:RET;---------------------------------------READSsd PUSH BC,DE        LD BC,P_DATA,D,8RZD1.64     INI        DEC D:JP NZ,RZD1        IN A        IN A        POP DE,BC        RET;-------SAVDSsd PUSH BC,DE        LD BC,P_DATA,D,8        OUT ASVD1.64     OUTI        DEC D:JP NZ,SVD1        LD A,#FF        OUT A:NOP        OUT A        POP DE,BC        RET;---------------------------------------CS_HIGH PUSH DE,BC        LD E,3,BC,P_CONF        OUT E:LD E,0,C,P_DATA        OUT E        POP BC,DE        LD A,1:OR A        RETCS__LOW PUSH DE,BC        LD BC,P_CONF,E,1:OUT E        POP BC,DE        RETOUT_COM PUSH BC        CALL CS__LOW        LD BC,P_DATA        OUT A:XOR A.3      OUT A:NOP        OUT A:DEC A        OUT A        POP BC        RETSECM200 PUSH HL,DE,BC,AF,BC        LD BC,P_DATA,A,CMD_58        CALL OUT_COM,IN_OUT        IN A:NOP        IN H:NOP        IN H:NOP        IN H:BIT 6,A:POP HL        JR NZ,SECN200        EX DE,HL:ADD HL,HL:EX DE,HL        ADC HL,HL        LD H,L,L,D,D,E,E,0SECN200 POP AF        LD BC,P_DATA:OUT A        NOP:OUT H        NOP:OUT L        NOP:OUT D        NOP:OUT E        LD A,#FF:OUT A        POP BC,DE,HL        RETIN_OUT  PUSH BC,DE        LD DE,#10FF        LD BC,P_DATAIN_WAIT IN A        CP E:JR NZ,IN_EXITIN_NEXT DEC D:JR NZ,IN_WAITIN_EXIT POP DE,BC        RET;---------------------------------------